[supervisord]
nodaemon=true
user=app

; ===================================
;  AuraQuant Web API Service (Uvicorn)
; ===================================
[program:uvicorn]
; --- CORRECTED COMMAND ---
; We still use our Python wait script, but the way we pass environment variables is now more robust.
command=/bin/bash -c "python /app/scripts/wait_for_postgres.py && alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port %(ENV_PORT)s"

; --- CRITICAL FIX 2: Explicitly define environment variables for the process ---
; This ensures that the Python script and all sub-processes have access to these values.
environment=
    POSTGRES_HOST=%(ENV_POSTGRES_HOST)s,
    POSTGRES_PORT=%(ENV_POSTGRES_PORT)s

directory=/app
user=app
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ========================================
;  AuraQuant Background Worker (Celery)
; ========================================
[program:celery_worker]
; --- CRITICAL FIX 1: Run celery as a Python module ---
; This is the most reliable way to invoke celery, as it uses the Python
; interpreter to find the celery package, bypassing any PATH issues.
command=python -m celery -A app.celery_worker.celery_app worker --loglevel=info

directory=/app
user=app
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
